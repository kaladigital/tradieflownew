/**
 * Roundcube webmail functions for the Elastic skin
 *
 * Copyright (c) The Roundcube Dev Team
 *
 * The contents are subject to the Creative Commons Attribution-ShareAlike
 * License. It is allowed to copy, distribute, transmit and to adapt the work
 * by keeping credits to the original autors in the README file.
 * See http://creativecommons.org/licenses/by-sa/3.0/ for details.
 *
 * @license magnet:?xt=urn:btih:90dc5c0be029de84e523b9b3922520e79e0e6f08&dn=cc0.txt CC0-1.0
 */
"use strict";function rcube_elastic_ui(){var i,a,n,t,o,s,r,e,l,c,d,u,p,m,h,f=this,v="normal",g="light",b=!1,_=!1,k=rcmail.is_framed(),w={config:{standard_windows:rcmail.env.standard_windows,message_extwin:rcmail.env.message_extwin,compose_extwin:rcmail.env.compose_extwin,help_open_extwin:rcmail.env.help_open_extwin},checkboxes:0,small_screen_config:{standard_windows:!0,message_extwin:!1,compose_extwin:!1,help_open_extwin:!1}},x={},C=[],y=[],E={menu:$("#layout-menu"),sidebar:$("#layout-sidebar"),list:$("#layout-list"),content:$("#layout-content")},T={menu:$("a.task-menu-button"),back_sidebar:$("a.back-sidebar-button"),back_list:$("a.back-list-button"),back_content:$("a.back-content-button")};function L(e,t,a){var i=$('<li role="menuitem">');(e=a?S($(e),!0,"hidden-big hidden-large"):$(e).detach()).contents().filter(function(){3==this.nodeType&&0==this.nodeValue.trim().length&&$(this).remove()}),e.is(".spacer")?i.addClass("spacer"):i.append(e),t.push(i)}function j(e){"string"==typeof e&&e.length||(e=$("h1.voice").text()||$("title").text()||""),E.content.find(".header > .header-title").text(e)}function z(e,t,a,i){be()&&w.frame_nav&&function(e,t){if(e.match(/_action=(create|add)/)||e.match(/_nav=hide/))return $(w.frame_nav).addClass("hide-nav-buttons");var a,i=$("[data-list]",E.list).data("list");if(!i||!(a=rcmail[i]))return $(w.frame_nav).is(".hide-nav-buttons")&&!$(".buttons",w.frame_nav).children().length&&$(w.frame_nav).addClass("hidden");$(w.frame_nav).removeClass("hide-nav-buttons hidden"),(e=a.get_single_selection())&&(a.rows&&a.rows[e]&&!a.rows[e].expanded?a.expand_row(t,e):a.get_node&&(r=a.get_node(e))&&r.collapsed&&a.expand(e));var n,o,s=$("#"+rcmail.env.contentframe),r=$("a.button.next",w.frame_nav).off("click").addClass("disabled"),e=$("a.button.prev",w.frame_nav).off("click").addClass("disabled");((o=a.get_next())||rcmail.env.current_page<rcmail.env.pagecount)&&r.removeClass("disabled").on("click",function(){w.content_lock=!0,ue(s),o?a.select(o):(rcmail.env.list_uid="FIRST",rcmail.command("nextpage"))}),((n=a.get_prev())&&("*"!=n||"subscription_list"!=i)||1<rcmail.env.current_page)&&e.removeClass("disabled").on("click",function(){w.content_lock=!0,ue(s),n?a.select(n):(rcmail.env.list_uid="LAST",rcmail.command("previouspage"))})}(t,e),a&&!E.content.is(":visible")?w.last_selected=E.content[0]:a||w.last_selected==u||w.content_lock||(w.last_selected=u),q(),j(i&&a?i:null),w.content_lock=!1}function M(e){"large"!=v&&!w.content_lock&&e.force&&V(),w.content_lock=!1,e.title&&$(".header > .header-title",E.list).text(e.title)}function O(e){var t={};"addressbook"!=rcmail.env.task&&"mail"!=rcmail.env.task||(t.force=!0),"mail"!=rcmail.env.task||rcmail.env.action||(e="string"==$.type(e)?e:rcmail.env.mailbox,e=rcmail.env.mailboxes[e],t.title=e?e.name:""),M(t)}function S(t,e,a,i){var n=!0,o=$("<a>"),s=t.attr("id")||(new Date).getTime(),r=s+"-clone",l=t[0].className+(a?" "+a:"");return e?(a=t.data("popup"))&&(o.data({popup:a,"toggle-button":t.data("toggle-button")}),Z(o[0]),n=!1,rcmail.register_menu_button(o[0],a)):(l=l.replace("btn-primary","primary").replace(/(btn[a-z-]*|button|disabled)/g,"").trim(),l+=" button"+(i?"":" disabled")),o.attr({id:r,href:"#",class:l}).append($('<span class="inner">').text(t.text())),n&&o.on("click",function(e){t.click()}),k&&!e?(o.data("target",t),y.push($.extend({button_id:r},D(t[0].id)))):(s=s,r=r,l=l.replace(" disabled",""),(s=D(s))&&rcmail.register_button(s.command,r,s.data.type,l,s.data.sel)),o}function D(e){var t,a,i;for(i in rcmail.buttons)for(t=0;t<rcmail.buttons[i].length;t++)if((a=rcmail.buttons[i][t]).id==e)return{command:i,index:t,data:a}}function I(){$("[data-list]").filter("ul,table").each(function(){var e,t,a,i,n,o=$(this),s=o.data("list");rcmail[s]&&rcmail[s].multiselect&&((a=(t=(e=o.parents("layout-sidebar,#layout-list,#layout-content").last()).find(".header")).find("ul")).length?(n=a.find("a.select").data("toggle-button"))&&(n=$("#"+n)):a=t,rcmail[s].enable_checkbox_selection(),!0===ke("list-selection")&&o.addClass("withselection"),n||(n=$("<a>").attr({class:"button selection disabled",role:"button",title:rcmail.gettext("select")}).on("click",function(){UI.toggle_list_selection(this,o.attr("id"))}).append($('<span class="inner">').text(rcmail.gettext("select"))),a.is(".menu")?(n.prependTo(a).wrap('<li role="menuitem">'),E.content&&(i=S(n,!0,"hidden-big hidden-large"),$('<li role="menuitem">').append(i).appendTo("#toolbar-menu"),n=n.add(i))):(i=o.data("list-select-replace"))?$(i).replaceWith(n):(n.appendTo(a).addClass("icon"),e.is("#layout-sidebar")||n.addClass("toolbar-button"))),rcmail.addEventListener("listupdate",function(e){e.list&&e.list==rcmail[s]&&(e.rowcount?n.addClass("active").removeClass("disabled").attr("tabindex",0):n.removeClass("active").addClass("disabled").attr("tabindex",-1))})),b&&rcmail[s]&&("function"==typeof rcmail[s].draggable?rcmail[s].draggable("destroy"):"boolean"==typeof rcmail[s].draggable&&(rcmail[s].draggable=!1),rcmail[s].dblclick_time=0)}),window.MutationObserver&&$("[data-label-msg]").filter("ul,table").each(function(){function e(){var e,t=n.data("label-msg"),a=n.is("ul")?n:n.children("tbody");if(!rcmail.env.search_request&&!rcmail.env.qsearch&&t&&!a.children(":visible").length)return e=n.data("label-ext"),a=n.data("create-command"),!e||a&&!rcmail.commands[a]||(t+=" "+e),void i.text(t).removeClass("hidden");i.addClass("hidden")}var i=$('<div class="listing-info hidden">').insertAfter(this),n=$(this),t=function(){if(rcmail.busy||!n.is(":visible"))return setTimeout(t,250);clearTimeout(w.list_timer),w.list_timer=setTimeout(e,50)};new MutationObserver(t).observe(n[0],{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]}),t()}),"print"!=rcmail.env.action&&$("#attachment-list > li").each(function(){re(this)});function t(e){"phone"==v&&rcmail.display_message(rcmail.gettext(e),"confirmation")}var e,a;rcmail.addEventListener("fileappended",function(e){e.attachment.complete&&(re(e.item),"text/vcard"==e.attachment.mimetype&&rcmail.commands["attach-vcard"]&&t("vcard_attachments.vcardattached"))}).addEventListener("managesieve.insertrow",function(e){A(e.obj)}).addEventListener("add-recipient",function(){t("recipientsadded")}),rcmail.init_pagejumper(".pagenav > input"),"mail"==rcmail.task?("compose"==rcmail.env.action&&(rcmail.addEventListener("compose-encrypted",function(e){$("a.mode-html, button.attach").prop("disabled",e.active),$("a.attach, a.responses:not(.edit)")[e.active?"addClass":"removeClass"]("disabled")}),$("#layout-sidebar > .footer:not(.pagenav) > a.button").click(function(){$(this).is(".disabled")&&rcmail.display_message(rcmail.gettext("nocontactselected"),"warning")}),window.MutationObserver&&(e=$("#attachment-list"),a=function(){oe("attach",0<e.children().length)},new MutationObserver(a).observe(e[0],{childList:!0}),a())),rcmail.env.extwin||"compose"!=rcmail.env.action&&"show"!=rcmail.env.action||$("a.mail",E.menu).attr({"aria-disabled":!1,onclick:"return rcmail.command('list','',this,event);"}),"preview"!=rcmail.env.action&&"show"!=rcmail.env.action||($("a").filter('[href^="mailto:"]').each(function(){var a,i;i=(a=this).onclick,a.onclick=null,$(a).on("click",function(e,t){return t||le($("#mailto-menu"),a,e,i)})}),ie())):"settings"==rcmail.task&&(rcmail.addEventListener("identity-encryption-show",function(e){A(e.container)}),rcmail.addEventListener("identity-encryption-update",function(e){A(e.container)})),rcmail.set_env({thread_padding:"1.5rem",popup_width_small:1025,popup_width:1200}),rcmail.env.devel_mode&&window.less?less.pageLoadFinished.then(function(){U(),rcmail.env.compose_focus_elem&&$(rcmail.env.compose_focus_elem).focus()}):U();var i,n=rcmail.env.date_format_localized;n&&(i=function(e){$(e).filter(".datepicker").attr("placeholder",n),$(e).parent().find("select").each(function(){he(this)})},$("input.datepicker").each(function(){i(this)}),rcmail.addEventListener("insert-edit-field",i))}function A(t){var e,a,i;t=t||document,$("input.button,button",t).not(".btn").addClass("btn").not(".btn-primary,.primary,.mainaction").addClass("btn-secondary"),$("input.button.mainaction,button.primary,button.mainaction",t).addClass("btn-primary"),$("button.btn.delete,button.btn.discard",t).addClass("btn-danger"),$.each(["warning","error","information","confirmation"],function(){var e=this;$(".box"+e+":not(.ui.alert)",t).each(function(){Q(this,e,!0)})}),t!=document&&1==$(".popup",t).children().length&&((i=$(".popup",t).children().first()).is("img")?$(".popup",t).addClass("justified"):i.is("label")&&(e=i.find("input").detach(),a=i.detach(),(i=e.attr("id"))||e.attr("id",i="dialog-input-elastic"),$(".popup",t).addClass("formcontent").append($('<div class="form-group row">').append(a.attr("for",i).addClass("col-sm-2 col-form-label")).append($('<div class="col-sm-10">').append(e))),e.focus()));var n="input:not(.button,.no-bs,[type=button],[type=radio],[type=checkbox],[type=file]),textarea";$(n,$(".propform",t)).addClass("form-control"),$("[type=checkbox]",$(".propform",t)).addClass("form-check-input"),$("select",t).addClass("form-control custom-select"),t!=document&&$(n,t).addClass("form-control"),$("table.propform",t).each(function(){var o=0,s=0,r=["sm",4,8];$(this).attr("class").match(/cols-([a-z]+)-(\d)-(\d)/)&&(r=[RegExp.$1,RegExp.$2,RegExp.$3]),$(this).find("> tbody > tr, > tr").each(function(){var e,t,a=$(this),i=["form-group","row"],n=a.children("td");2==n.length?(e=n.first(),t=n.last(),$("label",e).addClass("col-form-label"),e.addClass("col-"+r[0]+"-"+r[1]),t.addClass("col-"+r[0]+"-"+r[2]),1!=t.find("[type=checkbox]").length||t.find(".proplist").length?t.find("input:not([type=hidden]),textarea,radio,select").length?s++:(t.addClass("form-control-plaintext"),o++):(i.push("form-check"),t.find("a").length&&i.push("with-link"),s++),t.children(".datepicker")&&2==t.children("input").length&&t.addClass("datetime")):1==n.length&&n.css("width","100%"),a.addClass(i.join(" "))}),s<o&&$(this).addClass("text-only")}),$("td.input-group",t).each(function(){$(this).children().slice(1).addClass("input-group-append")}),$("fieldset.propform:not(.groupped) div.row",t).each(function(){var e=0<$("input:not([type=hidden]),select,textarea",this).length;e&&$(n,this).addClass("form-control"),$(this).children().last().addClass("col-sm-8"+(e?"":" form-control-plaintext")),$(this).children().first().addClass("col-sm-4 col-form-label"),$(this).addClass("form-group")}),$("fieldset.propform.groupped fieldset",t).each(function(){$(".row",this).each(function(){var e,t=0<$("input,select,textarea",this).length,a=$(this).children();t&&$(n,this).addClass("form-control"),a.length<2||((e=a.first()).is("select")?e.addClass("input-group-prepend"):e.wrap('<span class="input-group-prepend">').addClass("input-group-text"),t||a.last().addClass("form-control-plaintext"),$(".content",this).addClass("input-group-prepend input-group-append input-group-text"),$("a.deletebutton",this).addClass("input-group-text icon delete").wrap('<span class="input-group-append">'),$(this).addClass("input-group"))})}),$("fieldset.advanced",t).each(function(){var e=$(this).children(".propform").first();e.wrap($("<div>").addClass("collapse")),$(this).children("legend").first().addClass("closed").on("click",function(){e.parent().collapse("toggle"),$(this).toggleClass("closed")})}),$(".propform > .prop.block:not(.row)",t).each(function(){$(this).addClass("form-group row").each(function(){$("label",this).addClass("col-form-label").wrap($('<div class="col-sm-4">')),$("input,select,textarea",this).wrap($('<div class="col-sm-8">')),$(n,this).addClass("form-control")})}),$("td.rowbuttons > a",t).addClass("btn"),$("form.tabbed,div.tabbed",t).each(function(i,e){var n=[],t=$("<ul>").attr({class:"nav nav-tabs",role:"tablist"});$(this).addClass("tab-content").children("fieldset").each(function(e,t){var a=t.id||"tab"+i+"-"+e,e=$(t).data("navlink-class");$(t).addClass("tab-pane").attr({id:a,role:"tabpanel"}),a=$("<li>").addClass("nav-item").append($("<a>").addClass("nav-link"+(e?" "+e:"")).attr({role:"tab",href:"#"+a}).text($("legend",t).first().text()).click(function(e){return $(this).tab("show"),ee(e),!1})),$("legend",t).first().hide(),n.push(a)}),t.append(n).insertBefore(e),$("a.nav-link",t).first().click()}),$("input[type=file]:not(.custom-file-input)",t).each(function(){var t=rcmail.gettext("choosefile"+(this.multiple?"s":"")),e=$("<label>").attr({class:"custom-file-label","data-browse":rcmail.gettext("browse")}).text(t);$(this).addClass("custom-file-input").wrap('<div class="custom-file">'),$(this).on("change",function(){var e=t;this.files.length&&(e=this.files[0].name,1<this.files.length&&(e+=", ...")),$(this).next().text(e)}).parent().append(e)}),$("table:not(.table,.compact-table,.propform,.listing,.ui-datepicker-calendar)",t).filter(function(){return!$(this).parent().is(".propform")&&!$(this).parents("#message-header,.message-htmlpart,.message-partheaders,.boxinformation,.raw-tables").length}).each(function(){var e=$(this).addClass("table");e.parent().addClass("table-responsive-sm"),e.find("thead").addClass("thead-default")}),$("input.pretty-checkbox, .propform input[type=checkbox], .form-check input[type=checkbox], .popupmenu.form input[type=checkbox], .menu input[type=checkbox]",t).each(function(){pe(this)}),$(t).is(".actionrow")&&$("input[type=checkbox]",t).each(function(){pe(this)}),$(".input-group-combo > select",t).first().on("change",function(){function e(){t[t.next().is(":visible")?"removeClass":"addClass"]("alone")}var t=$(this);setTimeout(e,50),setTimeout(e,2e3)}).trigger("change"),$("#message-objects",t).children(":not(.ui.alert)").add(".part-notice").each(function(){var e=String($(this).removeClass("notice part-notice").attr("class")).split(/\s/)[0]||"warning";Q(this,e),$(this).addClass("box"+e),$("a",this).addClass("btn btn-primary btn-sm")}),$(".error",t).addClass("is-invalid"),"login"==rcmail.env.task&&t==document&&($("#rcmloginsubmit").addClass("btn-lg text-uppercase w-100"),$("#rcmloginoauth").addClass("btn btn-secondary btn-lg w-100"),$("#login-form table tr").each(function(){var e=$("input,select",this),t=$("label",this),a=e.data("icon"),i=$("<i>").attr("class","input-group-text icon "+e.attr("name").replace("_",""));a&&i.addClass(a),$(this).addClass("form-group row"),t.parent().css("display","none"),e.addClass(e.is("select")?"custom-select":"form-control").attr("placeholder",t.text()).before($('<span class="input-group-prepend">').append(i)).parent().addClass("input-group input-group-lg")})),$("select:not([multiple])",t).each(function(){he(this)})}function R(e){var n,t,a=[],i=$("#"+e.id).parent().is(".html-editor");e.config.plugins+=" autoresize",_e()&&(e.config.toolbar="undo redo | link image styleselect"),"mail"==rcmail.task&&"compose"==rcmail.env.action&&(n=$("#compose-content > form"),t=function(e){"Tab"==e.key&&e.shiftKey&&$("#compose-content > form").scrollTop(0)},a.push(function(e){e.on("keypress",t)}),$("#composebody").on("keypress",t),n.on("scroll",function(){var e=$(".tox-editor-container",n),t=e.find(".tox-toolbar-overlord"),a=e.offset(),i=n.offset().top;a&&a.top-i<0?t.css({position:"fixed",top:i+"px",width:e.width()+"px"}):t.css({position:"relative",top:0,width:"auto"})}),$(window).resize(function(){n.trigger("scroll")})),i&&(e.config.toolbar="plaintext | "+e.config.toolbar,e.config.setup_callback=function(t){t.ui.registry.addButton("plaintext",{tooltip:rcmail.gettext("plaintoggle"),icon:"close",onAction:function(e){rcmail.command("toggle-editor",{id:t.id,html:!1},"",e.originalEvent)&&$("#"+t.id).parent().removeClass("ishtml")}})}),a.push(function(e){e.on("OpenWindow",function(e){function t(e){var t=$(i).find(".tox-dialog__body"),a=$(i).find(".tox-dialog__footer").find("button");e||(4===a.length?t.closest(".tox-dialog").addClass("tox-search-dialog"):2==a.length&&a.first().insertAfter(a[1])),t.find("select").each(function(){he(this)}),t.find(".tox-checkbox > input").each(function(){pe(this)}),t.find(".tox-textarea,.tox-textfield").addClass("form-control")}var i=$(".tox-dialog:last")[0];window.MutationObserver&&new MutationObserver(t).observe($(".tox-dialog__body-content",i)[0],{childList:!0}),t()})}),rcmail.addEventListener("editor-load",function(e){$.each(a,function(){this(e.ref.editor)})})}function N(t){var e;$("ul",t.obj).addClass("menu listing iconized"),$(t.obj).addClass("popupmenu popover"),A(t.obj),$("input",t.obj).addClass("form-control"),be()&&$(t.obj).is(".googie_window")&&(e=rcmail.gettext("close"),e=$("<a>").attr("class","button icon cancel").text(e).click(function(e){e.stopPropagation(),$(".popover-overlay").remove(),$(t.obj).hide()}),$('<h3 class="popover-header">').append(e).prependTo(t.obj),$(".popover-overlay").length||$("<div>").attr("class","popover-overlay").appendTo("body").click(function(){$(this).remove()}),$("ul,button",t.obj).click(function(e){$(e.target).is("input")||$(".popover-overlay").remove()}))}function P(a){if(k&&$.each(y,function(e,t){a.command==t.command&&parent.$("#"+t.button_id)[a.status?"removeClass":"addClass"]("disabled")}),"mail"==rcmail.task)switch(a.command){case"reply-list":var e;1==rcmail.env.reply_all_mode&&(e=rcmail.gettext(a.status?"replylist":"replyall"),$(".toolbar a.reply-all").attr("title",e).find(".inner").text(e));break;case"compose-encrypted":$(".toolbar a.encrypt").parent().show();break;case"compose-encrypted-signed":$("#encryption-menu-button").show()}}function W(){var e=$(window).width(),t=e<=480?"phone":1200<e?"large":768<e?"normal":"small";b=e<=1024,v=t}function U(){var e,t,a;W(),q(),t=$e(),(a=$(document.documentElement))[0].className.match(/layout-([a-z]+)/)?RegExp.$1!=t.mode&&a.removeClass("layout-"+RegExp.$1).addClass("layout-"+t.mode):a.addClass("layout-"+t.mode),t.touch&&!a.is(".touch")?a.addClass("touch"):!t.touch&&a.is(".touch")&&a.removeClass("touch"),(e=be())?(rcmail.set_env(w.small_screen_config),rcmail.enable_command("extwin",!1)):(rcmail.set_env(w.config),rcmail.enable_command("extwin",!0)),$.each(C,function(){$(this)[e?"hide":"show"]()}),rcmail.triggerEvent("skin-resize",{mode:v})}function q(){if(!k||E.sidebar.length||E.list.length){switch(v){case"phone":F(),G(!1);break;case"small":F(),G(!0);break;case"normal":E.list.length&&(e=E.list.is(w.last_selected)||!E.sidebar.is(w.last_selected)&&!E.sidebar.is(".layout-sticky"),E.list[e?"removeClass":"addClass"]("hidden")),E.sidebar.length&&(e=!E.list.length||E.sidebar.is(w.last_selected)||E.sidebar.is(".layout-sticky"),E.sidebar[e?"removeClass":"addClass"]("hidden")),E.content.removeClass("hidden"),G(!0),Y(),!void(E.list.length&&$(".header > ul.menu",E.list).addClass("popupmenu"));break;case"large":$.each(E,function(e,t){t.removeClass("hidden")}),Y(),E.list&&$(".header > ul.menu.popupmenu",E.list).removeClass("popupmenu")}var e;H(v),B(),bw.webkit&&bw.ipad&&bw.agent.match(/OS 9/)&&$(".iframe-wrapper").each(function(){var e=$(this).height();e&&$(this).children("iframe").height(e)})}else B()}function H(e){var t=rcmail.env.additional_logos;t&&($("#logo").data("src-default")||$("#logo").data("src-default",$("#logo").attr("src")),"phone"==e&&t.small?$("#logo").attr("src",t.small):"phone"==e&&"dark"==g&&t["small-dark"]?$("#logo").attr("src",t["small-dark"]):"dark"==g&&t.dark?$("#logo").attr("src",t.dark):$("#logo").attr("src",$("#logo").data("src-default")))}function B(){$("#layout > div > .header").each(function(){var e,t=0,a=0,i={left:0,right:0};$(this).children(":visible:not(.position-absolute)").each(function(){e||!$(this).is(".header-title")?i[e?"right":"left"]+=this.offsetWidth:e=$(this)}),0+i.right>=i.left?(t=0,a=i.right+0-i.left):(a=0,t=i.left-(0+i.right)),$(e).css({"margin-right":t+"px","margin-left":a+"px","padding-right":"0px"})})}function F(){var e,t=!1;E.content.length&&(e=t=E.content.is(w.last_selected),E.content[e?"removeClass":"addClass"]("hidden"),$(".header > ul.menu",E.content).addClass("popupmenu")),E.list.length&&(e=!t&&E.list.is(w.last_selected),E.list[e?"removeClass":"addClass"]("hidden"),$(".header > ul.menu",E.list).addClass("popupmenu")),E.sidebar.length&&(e=!t&&(E.sidebar.is(w.last_selected)||!E.list.length),E.sidebar[e?"removeClass":"addClass"]("hidden")),t&&T.back_list.show()}function Y(){T.back_list.filter(function(){return 0==$(this).parents("#layout-sidebar").length}).hide(),$("ul.menu.popupmenu").removeClass("popupmenu")}function K(e){E.list.addClass("hidden"),E.sidebar.removeClass("hidden"),e&&E.sidebar.addClass("layout-sticky"),"small"!=v&&"phone"!=v||E.content.addClass("hidden"),B(),w.last_selected=E.sidebar[0]}function V(e){E.list.length||E.sidebar.length?(E.sidebar.addClass("hidden").removeClass("layout-sticky"),E.list.removeClass("hidden"),"small"!=v&&"phone"!=v||(w.last_selected=E.list[0]||E.sidebar[0],q(),rcmail.show_contentframe(!1),$("[data-list]",E.list).each(function(){var e=$(this).data("list");rcmail[e]&&(rcmail[e].clear_selection?rcmail[e].clear_selection():rcmail[e].select&&rcmail[e].select())})),e&&E.list.children(".scroller").scrollTop(0),w.last_selected=E.list[0]):history.back(),B()}function G(e){e?("phone"==v&&($('<div id="menu-overlay" class="popover-overlay">').on("click",function(){G(!1)}).appendTo("body"),w.menu_initialized||(w.menu_initialized=!0,$("a",E.menu).on("click",function(e){"phone"==v&&G()})),E.menu.addClass("popover")),E.menu.removeClass("hidden")):($("#menu-overlay").remove(),E.menu.addClass("hidden").removeClass("popover"))}function J(e){"loading"==e.type&&$(".iframe-loader:visible").length?rcmail.hide_message(e.object):(Q(e.object,e.type,!0),$(e.object).attr("role","alert"))}function Q(e,t,a){var i="ui alert",n=!$(e).is(".noicon");a&&n&&!$(e).is(".aligned-buttons")&&$(e).html($("<span>").html($(e).html())),(t={information:"alert-info",notice:"alert-info",confirmation:"alert-success",warning:"alert-warning",error:"alert-danger",loading:"alert-info loading",uploading:"alert-info loading",vcardattachment:"alert-info"}[t=t.split(" ")[0]])&&(i+=" "+t,n&&$("<i>").attr("class","icon").prependTo(e)),$(e).addClass(i)}function X(n){function e(){$(n).is(".open")&&s.click()}function o(){$(n)[!(a.val()||"mail"==rcmail.task&&$("#s_interval").val()||rcmail.gui_objects.search_filter&&"ALL"!=$(rcmail.gui_objects.search_filter).val()||rcmail.gui_objects.foldersfilter&&"---"!=$(rcmail.gui_objects.foldersfilter).val())?"removeClass":"addClass"]("active"),t[rcmail.gui_objects.search_filter&&"UNSEEN"==$(rcmail.gui_objects.search_filter).val()?"addClass":"removeClass"]("selected")}var t=$(),s=$("a.button.options",n),a=$("input:not([type=hidden])",n),i=a.attr("placeholder");$("form",n);a.is("#mailsearchform")&&(t=$("<a>").attr({class:"button unread",href:"#",role:"button",title:rcmail.gettext("showunread")}).on("click",function(e){$(rcmail.gui_objects.search_filter).val($(e.target).is(".selected")?"ALL":"UNSEEN"),rcmail.command("search")}).insertBefore(s)),s.on("click",function(e){var t=$(this).data("target"),a=$("#"+t),i=$(n).is(".open");a.length&&(i||(f[t]?f[t](a.get(0),this,e):"function"==typeof window[t]&&window[t](a.get(0),this,e)),a.next()[i?"show":"hide"](),a.toggleClass("hidden"),$(".floating-action-buttons").toggleClass("hidden"),$(n).toggleClass("open"),$("button.search",a).off("click.search").on("click.search",function(){s.click(),o()}))}),a.on("input change",o).on("focus blur",function(e){a.attr("placeholder","blur"==e.type?i:"")}),$("a.reset",n).on("click",function(e){a.val("").change().trigger("keyup.treelist",{keyCode:27}),$(n).is(".open")&&s.click(),rcmail.gui_objects.search_filter&&$(rcmail.gui_objects.search_filter).val("ALL"),rcmail.gui_objects.foldersfilter&&($(rcmail.gui_objects.foldersfilter).val("---").change(),rcmail.folder_filter("---")),o()}),rcmail.addEventListener("init",o).addEventListener("responsebeforesearch",o).addEventListener("beforelist",e).addEventListener("afterlist",o).addEventListener("beforesearch",e)}function Z(o,a){if(k&&be())return parent.UI.popup_init(o,a||window);a=a||window;var s,r=$(o).data("popup"),i=$(a.$("#"+r).get(0)),e=i,t=$(o).attr("title");$(o).attr({"aria-haspopup":"true","aria-expanded":"false","aria-owns":r}).popover({content:function(){return a!=window&&(i=e.clone(!0,!0)).attr("id",r+"-clone").appendTo(document.body).find("li > a").attr("onclick","").off("click").on("click",function(e){return $(this).is(".disabled")||($(o).popover("hide"),a.$("#"+$(this).attr("id")).click()),!1}),i.get(0)},trigger:$(o).data("popup-trigger")||"click",placement:$(o).data("popup-pos")||"bottom",animation:!0,boundary:"window",html:!0}).on("show.bs.popover",function(e){var t=i.data("popup-init");r&&x[r]&&(x[r].transitioning=!0),t&&f[t]?f[t](i.get(0),o,e):t&&a[t]&&a[t](i.get(0),o,e),s=$("div.popover:visible").length+1,i.removeClass("hidden").attr("aria-hidden",!1).find('[aria-haspopup="true"]').data("level",s+1).off("click.popup").on("click.popup",function(e){e.stopPropagation()}),be()||i.css("max-height",Math.min(539,$(window).height()-30))}).on("shown.bs.popover",function(e){var t,a,i=be(),n=$("#"+$(o).attr("aria-describedby"));s=$(o).data("level")||1,i&&(a=1<s?"back":"close",t=rcmail.gettext(a),a="button icon "+("back"==a?"back":"cancel"),$(".popover-header",n).empty().append($("<a>").attr("class",a).text(t).on("click",function(e){$(o).popover("hide"),1<s&&e.stopPropagation()}).on("mousedown",function(e){e.stopPropagation()}))),$.each(x,function(e,t){$(t.target).data("level")==s&&e!=r&&ae(e)}),"key"==$(o).data("event")&&(n.off("keydown.popup").on("keydown.popup","a.active",function(e){var t,a,i="next";switch(e.which){case 27:case 9:return $(o).popover("toggle").focus(),!1;case 38:case 63232:i="previous";case 40:case 63233:for(t=e.target.parentNode;t=t[i+"Sibling"];)if(a=$(t).children(".active")[0]){a.focus();break}return!1}}),n.find("a.active").first().focus()),r&&x[r]&&(x[r].transitioning=!1),i&&!$(".popover-overlay").length&&$("<div>").attr("class","popover-overlay").appendTo("body").click(function(){$(this).remove()}),$(".popover-body",n).addClass("webkit-scroller")}).on("hide.bs.popover",function(){1==s&&$(".popover-overlay").remove(),r&&x[r]&&i.is(":visible")&&(x[r].transitioning=!0)}).on("hidden.bs.popover",function(){/-clone$/.test(i.attr("id"))?i.remove():i.attr("aria-hidden",!0).addClass("hidden").appendTo(i.data("popup-parent")||document.body),$(".popover-body:empty").each(function(){$(this).parent().remove()}),r&&x[r]&&delete x[r]}).on("click",function(){$(this).data("event","mouse")}).on("keydown",function(e){if(e.originalEvent)switch(e.originalEvent.which){case 13:case 32:e.preventDefault(),$(this).data("event","key").popover("toggle");break;case 27:$(this).popover("hide")}}),t&&$(o).attr("title",t),i.attr("aria-hidden","true").data("button",o),i.data("editable")&&i.on("click mousedown",function(e){e.stopPropagation()})}function ee(t){a&&a>(new Date).getTime()-250||$(".popover.show").each(function(){var e=$(".popover-body",this).children().first().data("button");e&&t.target!=e&&!$(e).find(t.target).length&&"string"!=typeof e&&$(e).popover("hide"),e||$(this).remove()})}function te(e){if(e&&e.name&&(!e.props||!1!==e.props.skinable)){if(k&&be())return e.win||(e.win=window),parent.UI.menu_toggle(e);if("messagelistmenu"==e.name)(i=$("#listoptions-menu")).width(),o=i.clone(!0),$('select[name="sort_col"]',o).val(rcmail.env.sort_col||""),$('select[name="sort_ord"]',o).val(rcmail.env.sort_order||"ASC"),$('select[name="mode"]',o).val(rcmail.env.threading?"threads":"list"),$("select",o).each(function(){this.id=this.id+"-clone"}),$("label",o).each(function(){$(this).attr("for",$(this).attr("for")+"-clone")}),!void(o=rcmail.simple_dialog(o,rcmail.gettext("listoptionstitle"),function(e){rcube_event.is_keyboard(e.originalEvent)&&$("#listmenulink").focus();var t=$('select[name="sort_col"]',o).val(),a=$('select[name="sort_ord"]',o).val(),e=$('select[name="mode"]',o).val();return rcmail.set_list_options([],t,a,"threads"==e?1:0),!0},{closeOnEscape:!0,minWidth:400}));else if("menu-open"==e.event){var t,a,i=$("ul",e.obj).first(),n=e.props&&e.props.link?e.props.link:e.originalEvent.target;if(!i.length)return;$(n).is("span")&&(n=$(n).parents("a,li")[0]),e.name.match(/^drag/)&&(a=rcube_event.get_mouse_pos(e.originalEvent),n=$("<a>").css({position:"absolute",left:a.x,top:a.y,height:"1px",width:"1px",visibility:"hidden"}).appendTo(document.body).get(0)),a=$(n).data("popup-pos")||"right","folder-selector"==e.name?i.addClass("listing folderlist"):"addressbook-selector"==e.name||"contactgroup-selector"==e.name?i.addClass("listing contactlist"):i.hasClass("menu")&&i.addClass("listing"),"pagejump-selector"==e.name&&(i.addClass("simplelist"),e.obj.addClass("simplelist"),a="top"),x[e.name]&&ae(e.name,e.originalEvent),(t=function(){if(x[e.name]&&x[e.name].transitioning)return setTimeout(t,50);$(n).data("popup")||($(n).data({event:rcube_event.is_keyboard(e.originalEvent)?"key":"mouse",popup:e.name,"popup-pos":a,"popup-trigger":"manual"}),Z(n,e.win)),x[e.name]={target:n},$(n).popover("show")})()}else ae(e.name,e.originalEvent);var i,o;e.originalEvent.stopPropagation()}}function ae(e,t){var a=function(e){var t;x[e]?t=x[e].target:(t=$("#"+e).data("button"))||(e.match(/(?!-)menu$/)&&(e=e.substr(0,e.length-4)),t=$("#"+e+"-menu").data("button"));return t}(e);e.match(/^drag/)?$(a).popover("dispose").remove():($(a).popover("hide"),"forwardmenu"==e&&ee(t))}function ie(e){var t="mail.show.envelope",a=ke(t),i=e?!a:a,n=i?"summary":"details",a=$("div.header-content");$("div.header-links").find("a.headers-details,a.headers-summary").removeClass().addClass("headers-"+n).text(rcmail.gettext(n)),a[i?"addClass":"removeClass"]("details-view"),e&&we(t,i)}function ne(e,t){var a,i,n=rcmail.env.task,o=rcmail.env.search_mods,s=rcmail.env.mailbox,r=$("#s_scope",e).val(),l=$("#s_interval",e).val();"all"==r&&(s="*"),o=o||{},"mail"==n?(o[s]||(o[s]=rcube_clone_object(o["*"])),i=o[s],a="text",rcmail.env.search_scope=r,rcmail.env.search_interval=l):(i=o,a="*"),t&&(t.checked?i[t.value]=1:delete i[t.value],t.value==a&&$('input[name="s_mods[]"]',e).map(function(){this!=t&&(this.checked=!0,t.checked?(this.disabled=!0,delete i[this.value]):(this.disabled=!1,i[this.value]=1))}),rcmail.set_searchmods(i))}function oe(e,t){var a=$("#composestatusbar"),i=a.find("a.button.icon."+e);t?i.length||$("<a>").attr("class","button icon "+e).on("click",function(){K()}).appendTo(a):i.remove()}function se(e,t,a){var i=$(t).parent().attr("id").replace(/^attach/,"");return $.each(["open","download","rename"],function(){var t=this;$("#attachmenu"+t,e).off("click").attr("onclick","").click(function(e){return rcmail.command(t+"-attachment",i,this,e.originalEvent)})}),rcmail.command("menu-open",{menu:"attachmentmenu",id:i},e,a)}function re(e){var t,a,i;(e=$(e)).is(".no-menu")||e.children(".dropdown").length||(t=rcmail.gettext("options"),a=e.find("a.filename"),i=$("<a>").attr({href:"#",tabindex:a.attr("tabindex")||0,title:t,class:"button icon dropdown skip-content"}).on("click",function(e){return se($("#attachmentmenu"),i,e)}).append($("<span>").attr("class","inner").text(t)),a.length?i.insertAfter(a):i.appendTo(e))}function le(e,i,t,a){var n=$(i).attr("href").replace(/^mailto:/,"");return n.indexOf("@")<0||(e.find("a").off("click").removeClass("active"),rcmail.env.has_writeable_addressbook&&$(".addressbook",e).addClass("active").on("click",function(e){var t=n,a=$(i).filter(".rcmContactAddress").text(),t=t.split("?")[0].split(",")[0].replace(/(^<|>$)/g,"");return a&&(t='"'+(a=a.replace("<"+t+">","")).trim()+'" <'+t+">"),rcmail.command("add-contact",t,this,e.originalEvent)}),$(".compose",e).addClass("active").on("click",function(e){return a?(i.onclick=a,$(i).trigger("click",[!0]),i.onclick=null):rcmail.command("compose",n,this,e.originalEvent),!1}),rcmail.command("menu-open",{menu:"mailto-menu",link:i},i,t.originalEvent))}function ce(t){var e=$("#quotadisplay"),a=e.find(".bar"),i=t.total?t.percent:0;0<i&&i<10&&(i=10),(a=!a.length?$('<span class="bar"><span class="value"></span></span>').appendTo(e):a).find(".value").css("width",i+"%")[90<=i?"addClass":"removeClass"]("warning"),e.attr({"data-original-title":"",title:e.find(".count").attr("title")}),t.table?e.css("cursor","pointer").data("popup-pos","top").off("click").on("click",function(e){rcmail.simple_dialog(t.table,"quota",null,{cancel_button:"close"})}):e.tooltip("dispose").tooltip({trigger:be()?"click":"hover"})}function de(a){a=a.replace(/[,;\s]*[\r\n]+/g,",").trim();var i=[],e='(\\S+|("[^"]+"))@\\S+',n=new RegExp("(<"+e+">)"),o=new RegExp("("+e+")"),e=a.match(/(?=\S)[^",;]*(?:"[^\\"]*(?:\\[,;\S][^\\"]*)*"[^",;]*)*/g);return $.each(e||[],function(){if(this.length&&(n.test(this)||o.test(this))){var e,t=this;for(a=a.replace(t,"");t.length&&0===t.indexOf(RegExp.$1)&&(e=RegExp.$1,i.push({name:"",email:e.replace(/(^<|>$)/g,"")}),t=t.replace(e,"").trim(),n.test(t)||o.test(t)););e!=RegExp.$1&&(e=RegExp.$1,i.push({name:t.replace(e,"").trim(),email:e.replace(/(^<|>$)/g,"")}))}}),a=a.replace(/[,;]+/,",").replace(/^[,;\s]+/,""),{recipients:i,text:a}}function ue(e){var t;(e=$(e)).length&&(t=$('<div class="iframe-loader">').append($('<div class="spinner spinner-border" role="status">').append($('<span class="sr-only">').text(rcmail.gettext("loading")))),e.on("load error loaded",function(){setTimeout(function(){t.remove()},500)}).parent().append(t),_&&e.parent().addClass("ios-scroll"))}function pe(e){var t,a;(e=$(e)).is(".custom-control-input")||((a=e.attr("id"))||(a="icochk"+ ++w.checkboxes,e.attr("id",a)),e.parent().is("label")?(t=e.parent(),e=e.detach(),t.before(e)):t=$("<label>"),t.attr({for:a,class:"custom-control-label",title:e.attr("title")||""}).on("click",function(e){e.stopPropagation()}),e.addClass("form-check-input custom-control-input").wrap('<div class="custom-control custom-switch">').parent().append(t))}function me(e){var t=$(e.row).find("input[id^=icochk]");t.length&&(e="icochk"+ ++w.checkboxes,t.attr("id",e).next("label").attr("for",e))}function he(u){var p,t,m;bw.iphone||bw.ipad||(u=$(u)).is(".pretty-select")||(p="select"+u.attr("id")+u.attr("name"),t=function(){if(u[0].ownerDocument.defaultView.$(".select-menu .listing").data("ident")==p)return!0},m=function(){var e=t();return u.popover("dispose").focus(),!e},u.addClass("pretty-select custom-select form-control").on("mousedown keydown",function(e){if(!(u=$(e.target)).prop("disabled"))return 9==e.which?(m(),!0):27==e.which||"mousedown"==e.type&&t()?m():(u.focus(),u.prop("disabled",!0),setTimeout(function(){u.prop("disabled",!1)},0),e.stopPropagation(),"mousedown"==e.type||13==e.which||32==e.which||40==e.which||63233==e.which?(function(a){var s,r=-1,i=[],l=[],e=u.closest(".ui-dialog")[0],t=(document.documentElement.clientHeight||$(document.body).height())-75,n=$(document.body).width()-20,o=Math.min(u.outerWidth(),n),c=u.val();be()||(t*=.5),ee(a),$("option",u).each(function(){var e=$(this).text(),t=$('<a href="#">').data("value",this.value).addClass(this.disabled?"disabled":"active"+(this.value==c?" selected":""));e.length?(t.text(e),l.push(this.disabled?"":e.charAt(0).toLowerCase())):(t.html("&nbsp;"),l.push("")),i.push($("<li>").append(t))});var d=$('<ul class="listing selectable iconized">').attr("data-ident",p).data("button",u[0]).append(i).on("click","a.active",function(){var e=$(this).data("value"),t=m();return u.val(e).change(),t}).on("keydown","a.active",function(e){var t,a,i,n,o="next";switch(e.which){case 27:case 9:return m();case 13:case 32:return $(this).click(),!1;case 38:case 63232:o="previous";case 40:case 63233:for(t=e.target.parentNode;t=t[o+"Sibling"];)if(n=$(t).children(".active")[0]){n.focus();break}return!1;default:(a=e.originalEvent.key)&&1==a.length&&(a=a.toLowerCase(),s!=a&&(r=-1),(-1<(i=l.indexOf(a,r+1))||-1<(i=l.indexOf(a)))&&d.find("a").eq(i).focus(),s=a,r=i)}});u.popover("dispose").popover({container:e||document.body,content:d[0],placement:"bottom",trigger:"manual",boundary:"viewport",html:!0,offset:"0,2",sanitize:!1,template:'<div class="popover select-menu" style="min-width: '+o+"px; max-width: "+n+'px"><div class="popover-header"></div><div class="popover-body" style="max-height: '+t+'px"></div></div>'}).on("shown.bs.popover",function(){u.focus(),d.parent().prev().empty().append($('<a class="button icon cancel">').text(rcmail.gettext("close")).on("click",function(e){return e.stopPropagation(),m()}));var e,t=d.find("a.selected").first();t.focus().length?(e=d.parent(),r=d.find("a").index(t[0]),s=l[r],5<r&&e.scrollTop(e.scrollTop()+e.height()/2)):rcube_event.is_keyboard(a)&&d.find("a.active").first().focus(),d.on("mousedown",function(e){e.stopPropagation()})}).popover("show")}(e),a=(new Date).getTime(),!1):void 0)}))}function fe(a,e,t,i,n){var o=$('<div class="input-group"><input type="text" class="form-control"><span class="input-group-append"><a class="icon reset input-group-text" href="#"></a></span></div>'),s=o.find("input").attr({value:e,name:i.name+"[]",size:$(i).data("size"),title:i.title,placeholder:i.placeholder}).keydown(function(e){if(13==e.which){var t=fe(a,"",(new Date).getTime(),i,s.parent());$("input",t).focus()}else if((8==e.which||46==e.which)&&""==s.val()){e=s.parent();if(1<a.children().length)return(e.prev().length?e.prev():e.next()).children("input").focus(),e.remove(),!1}});return o.find("a.reset").click(function(){var e=$(this.parentNode.parentNode);1<a.children().length?($("input",e.next().length?e.next():e.prev()).focus(),e.remove()):$("input",e).val("").focus()}),o.find("input,a").on("focus",function(){a.addClass("focused")}).on("blur",function(){a.removeClass("focused")}),n?n.after(o):o.appendTo(a),o}function ve(n){function o(e){n.css({width:Math.max(100,e),flex:"none"})}var e=n.find(".scroller .listing").first().attr("id"),s=rcmail.env.task+"."+(e||rcmail.env.action+"."+n.attr("id")),e=ke(s),r=n.is(".sidebar-right");n[r?"prev":"next"]().length&&($('<div class="column-resizer">').addClass(r?"inverted":null).appendTo(n).on("mousedown",function(e){var a,t=$(this),i=n.position().left;t.addClass("active"),document.body.style.userSelect="none",$(document).on("mousemove.resizer",function(t){clearTimeout(a),a=setTimeout(function(){r&&(i=n.position().left);var e=rcube_event.get_mouse_pos(t).x,e=r?n.width()+(i-e):e-i;o(e)},5)}).on("mouseup.resizer",function(){$(document).off(".resizer"),$("iframe").off(".resizer"),document.body.style.userSelect="auto",t.removeClass("active"),we(s,n.width())})}),e&&o(e))}function ge(e,t,a,i){if(!be()||!0===i)return/_task=mail/.test(e)&&/_action=get/.test(e)&&(t=!0),w.open_window.call(rcmail,e,t,a);e=rcmail.add_url(e,"_framed",1),e=rcmail.add_url(e,"_extwin",1);var n,i="",t={cancel_button:"close",width:768,height:768},a=$("<iframe>").attr({id:"windowframe",src:e});return/_action=([a-z_]+)/.test(e)&&(n=rcmail.labels[RegExp.$1])&&(i=n),/_frame=1/.test(e)&&(t.dialogClass="no-titlebar"),rcmail.simple_dialog(a,i,null,t),!0}function $e(){if(k){var e=$(parent.document.documentElement);return{mode:e[0].className.match(/layout-([a-z]+)/)?RegExp.$1:v,touch:e.is(".touch")}}return{mode:v,touch:b}}function be(){var e=$e();return"phone"==e.mode||"small"==e.mode}function _e(){return $e().touch}function ke(e){var t;return null!=(i=i||rcmail.local_storage_get_item("prefs.elastic",{}))[e]||null!=(t=rcmail.get_cookie(e))&&(i[e]=t,rcmail.local_storage_set_item("prefs.elastic",i)&&rcmail.set_cookie(e,t,new Date)),i[e]}function we(e,t){var a;i[e]=t,rcmail.local_storage_set_item("prefs.elastic",i)||((a=new Date).setYear(a.getFullYear()+1),rcmail.set_cookie(e,t,a))}this.register_content_buttons=function(e){{var t;w.frame_nav&&e&&e.length&&(t=w.frame_nav.children(".buttons"),C=[],$.each(e,function(){this.data("target")&&C.push(this.data("target"))}),t.html("").append(e))}},this.menu_hide=ae,this.menu_toggle=te,this.menu_destroy=function(e){$("[aria-owns="+e+"]").popover("dispose").data("popup",null)},this.popup_init=Z,this.about_dialog=function(e){var t,a,i=!1,n=$("<iframe>").attr({id:"aboutframe",src:rcmail.url("settings/about",{_framed:1})}),o=$("#supportlink");o.length&&(t=o.attr("href"))&&(i=o.text(),a=function(e){t.indexOf("mailto:")<0?window.open(t):location.href=t});rcmail.simple_dialog(n,$(e).text(),a,{button:i,button_class:"help",cancel_button:"close",height:400})},this.headers_dialog=function(){var e={_uid:rcmail.env.uid,_mbox:rcmail.env.mailbox,_framed:1},e=$("<iframe>").attr({id:"headersframe",src:rcmail.url("headers",e)});rcmail.simple_dialog(e,rcmail.gettext("arialabelmessageheaders"),null,{cancel_button:"close",height:400})},this.import_dialog=function(){if(!rcmail.commands["import-messages"])return;var t=$("#uploadform").clone(!0);rcmail.simple_dialog(t,rcmail.gettext("importmessages"),function(e){return rcmail.command("import-messages",$(t.find("form")[0]))},{button:"import",closeOnEscape:!0,minWidth:400})},this.props_dialog=function(){var e=$("#properties-menu").clone();rcmail.simple_dialog(e,rcmail.gettext("properties"),null,{cancel_button:"close",height:400})},this.headers_show=ie,this.spellmenu=function(e){var t,a,i=[],n=rcmail.spellcheck_lang(),o=$("ul",e);if(!o.length){for(t in o=$('<ul class="selectable listing iconized" role="menu">'),rcmail.env.spell_langs)a=$('<li role="menuitem">'),$('<a href="#'+t+'" tabindex="0"></a>').text(rcmail.env.spell_langs[t]).addClass("active").data("lang",t).on("click keypress",function(e){if("keypress"!=e.type||13==rcube_event.get_keycode(e))return rcmail.spellcheck_lang_set($(this).data("lang")),rcmail.hide_menu("spell-menu",e),!1}).appendTo(a),i.push(a);o.append(i).appendTo(e)}$("li",o).each(function(){var e=$("a",this);e.data("lang")==n?e.addClass("selected").attr("aria-selected","true"):e.hasClass("selected")&&e.removeClass("selected").removeAttr("aria-selected")})},this.searchmenu=function(e){var t,a,i=$('input[name="s_mods[]"]',e),n=$("#s_scope",e),o=rcmail.env.mailbox,s=rcmail.env.search_mods,r=rcmail.env.search_scope||"base";$(e).data("initialized")||($(e).data("initialized",!0),i.length&&(i.on("change",function(){ne(e,this)}),rcmail.addEventListener("beforesearch",function(){ne(e)})));if(rcmail.env.search_mods)if("mail"==rcmail.env.task?(s=s[o="all"==r?"*":o]||s["*"],a="text",n.val(r)):a="*",s[a])i.map(function(){this.checked=!0,this.disabled=this.value!=a});else for(t in i.prop("disabled",!1).prop("checked",!1),s)i.filter('[value="'+t+'"]').prop("checked",!0)},this.headersmenu=function(e,t,a){$("li > a",e).each(function(){var e=$(this),t="#compose_"+e.data("target");e[$(t).is(":visible")?"removeClass":"addClass"]("active").off().on("click",function(){$(t).removeClass("hidden").find(".recipient-input input").focus(),e.removeClass("active"),rcmail.set_menu_buttons()})})},this.header_reset=function(e){$("#"+e).val("").change().closest(".form-group").nextAll(":not(.hidden)").first().find("input").focus(),$("a[data-target="+e.replace(/^_/,"")+"]").addClass("active"),rcmail.set_menu_buttons()},this.compose_status=oe,this.attachmentmenu=se,this.mailtomenu=le,this.recipient_selector=function(e,t){t=t||{};function a(){n.is(":visible")&&rcmail.env.recipient_dialog.dialog("close")}var i=rcmail.gettext(t.title||"insertcontact"),n=$("#recipient-dialog"),o=n.parent();rcmail.env.recipient_selector_initialized||(rcmail.addEventListener("add-recipient",a),rcmail.env.recipient_selector_initialized=!0);e&&(rcmail.env.focused_field="#_"+e);rcmail.contact_list.clear_selection(),rcmail.contact_list.multiselect=!("multiselect"in t)||t.multiselect,rcmail.env.recipient_dialog=rcmail.simple_dialog(n,i,function(){if(t.action)return t.action(),void a();rcmail.command("add-recipient")},{button:rcmail.gettext(t.button||"insert"),button_class:t.button_class||"insert recipient",height:600,classes:{"ui-dialog-content":"p-0"},open:function(){$("#directorylist a").first().focus()},close:function(){n.appendTo(o),$(this).remove(),$(t.focus||rcmail.env.focused_field).focus()}})},this.show_list=V,this.show_sidebar=K,this.smart_field_init=function(a){var e=a.id+"_list",i=$('<div class="multi-input"><div class="content"></div><div class="invalid-feedback"></div></div>'),t=a.value?a.value.split("\n"):[""];if($("#"+e).length)return;$.each(t,function(e,t){fe($(".content",i),t,0,a)}),i.attr("id",e),(a=$(a)).attr("disabled")?i.hide():a.prop("disabled",!0);a.data("hidden")&&i.hide();a.after(i),a.hasClass("is-invalid")&&(i.addClass("is-invalid"),$(".invalid-feedback",i).text(a.data("error-msg")))},this.smart_field_reset=function(a,e){var t=a.id+"_list",e=e.length?e:[""],i=$("#"+t).children(".content");i.empty(),$.each(e,function(e,t){fe(i,t,0,a)})},this.form_errors=function(e){$.each(e,function(){var e=$("#"+this[0]).addClass("is-invalid");if("list"==e.data("type"))return e.data("error-msg",this[2]),void $("#"+this[0]+"_list > .invalid-feedback").text(this[2]);e.after($('<span class="invalid-feedback">').text(this[2]))})},this.switch_nav_list=function(e){var t,a,i=$("a",e),n=$(e).next();n.height()?(n.animate({height:"0"},250),i.addClass("expand").removeClass("collapse"),$(e).removeClass("expanded")):(t=$("tr,li",n).filter(function(){return"none"!=this.style.display}),a=$(t[0]).height()||50,n.animate({height:Math.min(5,t.length)*a+1+"px"},250),i.addClass("collapse").removeClass("expand"),$(e).addClass("expanded"))},this.searchbar_init=X,this.pretty_checkbox=pe,this.pretty_select=he,this.datepicker_init=function(e){window.MutationObserver&&$(e).not("[data-observed]").each(function(){var i,n=!0,o=k?parent:window;$(this).attr("data-observed","1"),k&&($(this).detach().appendTo(parent.document.body),$('<div id="ui-datepicker-div" class="hidden">').appendTo(document.body)),new MutationObserver(function(e){$.each(e,function(e,t){var a;"attributes"==t.type?(a="true"==$(t.target).attr("aria-hidden"))!=n&&(a?i&&i.remove():i=$("<div>").attr("class","ui-widget-overlay datepicker").appendTo(o.document.body).click(function(e){$(this).remove(),k&&$.datepicker._hideDatepicker()}),n=a):t.addedNodes.length&&(o.UI.bootstrap_style(t.target),k&&(o.$("select.ui-datepicker-month",t.target).on("change",function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"M")}),o.$("select.ui-datepicker-year",t.target).on("change",function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"Y")})))})}).observe(this,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["aria-hidden"]})})},this.bootstrap_style=A,this.toggle_list_selection=function(e,t){$(e).is(".active")&&we("list-selection",$("#"+t).toggleClass("withselection").is(".withselection"))},this.get_screen_mode=function(){return v},this.is_mobile=be,this.is_touch=_e,W(),function(){var e,t;function a(){try{$(this.contentWindow.document).find("html")["dark"==g?"addClass":"removeClass"]("dark-mode")}catch(e){}}function i(){"dark"==g?($("#taskmenu a.theme").removeClass("dark").addClass("light").find("span").text(rcmail.gettext("lightmode")),$("html").addClass("dark-mode")):($("#taskmenu a.theme").removeClass("light").addClass("dark").find("span").text(rcmail.gettext("darkmode")),$("html").removeClass("dark-mode")),H(v),$("iframe").each(a)}"print"!=rcmail.env.action&&(t=window.matchMedia("(prefers-color-scheme: dark)"),$("#taskmenu a.theme").on("click",function(){g=$(this).is(".dark")?"dark":"light",i(),rcmail.set_cookie("colorMode",g)}),t.addListener(function(e){g=e.matches?"dark":"light",i(),rcmail.set_cookie("colorMode",null)}),(e=rcmail.get_cookie("colorMode"))?g=e:t.matches&&(g="dark"),i(),$("iframe").on("load",a))}(),w.last_selected=$("#layout > div.selected")[0],!w.last_selected&&E.content.length&&$.each(["sidebar","list","content"],function(){if(E[this].length)return w.last_selected=E[this][0],E[this].addClass("selected"),!1}),$(window).on("resize",function(){clearTimeout(w.resize_timeout),w.resize_timeout=setTimeout(function(){U()},25)}),w.open_window=rcmail.open_window,rcmail.open_window=ge,rcmail.addEventListener("message",J).addEventListener("menu-open",te).addEventListener("menu-close",te).addEventListener("editor-init",R).addEventListener("autocomplete_create",N).addEventListener("googiespell_create",N).addEventListener("setquota",ce).addEventListener("enable-command",P).addEventListener("clonerow",me).addEventListener("init",I),(E.list.length||E.content.length)&&be()&&(n=[],$("[data-fab]").each(function(){var e=$(this),t=e.data("fab-task")||"*",a=e.data("fab-action")||"*";"*"!=t&&t!=rcmail.env.task||"*"!=a&&a!=rcmail.env.action&&("none"!=a||rcmail.env.action)||n.push(S(e,!1,!1,!0))}),n.length&&$('<div class="floating-action-buttons">').append(n).appendTo(E.list.length?E.list:E.content)),E.sidebar.length&&ve(E.sidebar),E.list.length&&ve(E.list),A(),w.got_smart_toolbar||(w.got_smart_toolbar=!0,o=[],s=[],r=$e(),E.content.find(".header > .menu").each(function(){var e=$(this);e.children().each(function(){L(this,o)}),e.remove()}),E.list.find(".header > .menu").each(function(){var e=$(this);t=e.next(),e.children().each(function(){"large"!=r.mode&&$(this).data("popup-pos","right"),L(this,o,!0),L(this,s)}),e.remove()}),$('ul[data-menu="toolbar-small"] > li > a').each(function(){var e=$(this).clone();e.attr("id",this.id+"_clone"),o.push($('<li role="menuitem">').addClass("hidden-big").append(e))}),s.length&&(l=E.list.children(".header"),c={class:"menu toolbar popupmenu listing iconized",id:"toolbar-list-menu"},d=$('<a class="button icon toolbar-list-button" href="#list-menu">').attr({"data-popup":"toolbar-list-menu"}),e=$("<ul>").attr(c).data("popup-parent",l).append(s),t.length?e.insertBefore(t):l.append(e),l.append(d)),o.length&&(l=E.content.children(".header"),c={class:"menu toolbar popupmenu listing iconized",id:"toolbar-menu"},d=$('<a class="button icon toolbar-menu-button" href="#menu">').attr({"data-popup":"toolbar-menu"}),l.append($("<ul>").attr(c).data("popup-parent",l).append(o)).append(d),E.list.find("a.toolbar-menu-button").click(function(e){e.stopPropagation(),d.click()}))),E.list.length&&(u=w.last_selected,E.content.find("iframe").on("load",function(e){var t,a="",i=!0;$(this).parent(".iframe-wrapper").scrollTop(0);try{i=!(a=(t=e.target.contentWindow).location.href).endsWith(rcmail.env.blankpage),$(t).on("unload",j)}catch(e){}z(e,a,i)}),rcmail.addEventListener("afterlist",O).addEventListener("afterlistgroup",O).addEventListener("afterlistsearch",O).addEventListener("show-list",function(e){e.force=!0,M(e)}).addEventListener("show-content",function(e){e.obj&&!$(e.obj).is("iframe")&&($(e.scrollElement||e.obj).scrollTop(0),be()&&ue(e.obj)),z(e.event||new Event,"_action="+(e.mode||"edit"),!0,e.title)})),$("[data-popup]").each(function(){Z(this)}),$(document).on("click",ee),rcube_webmail.set_iframe_events({mousedown:ee,touchstart:ee}),h=[],$.ui&&$.widget("ui.dialog",$.ui.dialog,{open:function(){var e,t,a,i,n,o;return $(this.element).is(".iframe")&&(this.options.width=Math.max(576,this.options.width)),this._super(),e=this,t=$(e.uiDialog),a=t.width(),i=t.height(),n=$(window).width(),o=$(window).height(),n<=480?t.css({width:"100%",height:"100%"}):(o<i&&t.css("height","100%"),n<a&&t.css("width","100%")),$(document).click(),ue($("div.popup > iframe",t)),A(e.uiDialog),this},close:function(){return this._super(),$(".select-menu:visible").remove(),this}}),T.menu.on("click",function(){return G(!0),!1}),T.back_sidebar.on("click",function(){return K(),!1}),T.back_list.on("click",function(){return V(),!1}),T.back_content.on("click",function(){return E.list.addClass("hidden"),E.sidebar.addClass("hidden"),E.content.removeClass("hidden"),E.sidebar.removeClass("layout-sticky"),B(),w.last_selected=E.content[0],!1}),$(".searchbar").each(function(){X(this)}),!k||rcmail.env.extwin||parent.$(".ui-dialog:visible").length?k||(p=(p=E.content.find(".boxtitle").first().detach().text())||$("h1.voice").first().text())&&E.content.find(".header > .header-title").text(p):(p=$("h1.voice").first().text())&&parent.$("#layout-content > .header > .header-title:not(.constant)").text(p),k||!E.content.length||E.content.is(".no-navbar")||E.content.children(".frame-content").length||(w.frame_nav=$('<div class="footer menu toolbar content-frame-navigation hide-nav-buttons">').append($('<a class="button prev">').append($('<span class="inner"></span>').text(rcmail.gettext("previous")))).append($('<span class="buttons">')).append($('<a class="button next">').append($('<span class="inner"></span>').text(rcmail.gettext("next")))).appendTo(E.content)),$("a[data-content-button]").each(function(){h.push(S($(this)))}),$(".formbuttons").filter(function(){return!$(this).parent(".searchoptions").length}).find("button").each(function(){var e=$(this);(k||e.parents("#layout-content").length)&&(e.is(".cancel")?e.addClass("hidden"):h.push(S(e)))}),(k?parent.UI:f).register_content_buttons(h),(m=rcmail.gui_objects.messageform)&&(m=$('form[name="'+m+'"]'),$("#_cc, #_bcc, #_replyto, #_followupto",$(".compose-headers")).each(function(){$(this).on("change",function(){$("#compose"+$(this).attr("id"))[this.value?"removeClass":"addClass"]("hidden")})}),$("#compose-options").find("textarea,input,select").each(function(){var e=$("<input>").attr({type:"hidden",name:$(this).attr("name")}).appendTo(m);$(this).attr("tabindex",2).on("change",function(){e.val("checkbox"!=this.type||this.checked?$(this).val():"")}).change()})),$("[data-recipient-input]").each(function(){function r(){$(e).val(s.text()+l.val())}function o(e){return e=de(e=(e||l.val()).replace(/[,;\s]+$/,"")),$.each(e.recipients,function(){c(this.name,this.email)}),l.val(e.text),r(),0<e.recipients.length}var e,s,l,t,c;e=this,t="",c=function(e,t,a){var i=$('<li class="recipient">'),n=$('<span class="name">').html(function(e){var t,a,i="",n=e.length;'"'!=e.charAt(0)&&-1<e.indexOf('"')&&(e='"'+e.replace("\\","\\\\").replace('"','\\"')+'"');for(t=0;t<n;t++)switch(a=e.charAt(t)){case'"':if(0<t&&t<n-1){i+='"';break}i+='<span class="quotes">'+a+"</span>";break;case"\\":i+='<span class="quotes">'+a+"</span>","\\"==e.charAt(t+1)&&(i+=a,t++);break;case"<":i+="&lt;";break;case">":i+="&gt;";break;default:i+=a}return i}(e||t)).on("dblclick",function(e){var t,a,i,n;e=e,t=c,a=$(e.target).parents(".recipient"),i=a.text().replace(/,+$/,""),n=$("<input>").attr({type:"text",size:50}).val(i),e=$("<label>").text(rcmail.gettext("recipient")).append(n),rcmail.simple_dialog(e,"recipientedit",function(){var e=n.val();if(e){if(e!=i){if(1!=(e=de(e)).recipients.length)return!1;t(e.recipients[0].name,e.recipients[0].email,a)}return!0}})}),o=$('<span class="email">'),s=$("<a>").attr({class:"button icon remove"}).click(function(){return i.remove(),r(),l.focus(),!1});e&&(t=" <"+t+">"),o.text((e?t:"")+","),i.attr("title",e?e+t:null).append([n,o,s]),a?a.replaceWith(i):i.insertBefore(l.parent()),r()},l=$("<input>").attr({type:"text",tabindex:$(e).attr("tabindex")}).on("paste change",function(e,t){var a,i,n=this.value;"paste"==e.type?(i=(e.originalEvent.clipboardData||window.clipboardData).getData("text")||"",n=n.substring(0,this.selectionStart)+i+n.substring(this.selectionEnd),e.preventDefault()):t&&(a=s.find("li.recipient").last()).length&&-1<this.value.indexOf(a.text().replace(/[ ,]+$/,""))&&a.remove(),o(n)}).on("keydown",function(e){return 8!=e.keyCode||l.val().length?!((" "==e.key||","==e.key||";"==e.key||"Enter"==e.key&&!rcmail.ksearch_visible())&&o())&&void 0:(s.children("li.recipient").last().remove(),r(),!1)}).on("blur",function(){s.removeClass("focus")}).on("focus mousedown",function(){s.addClass("focus")}),s=$("<ul>").addClass("form-control recipient-input ac-input rounded-left").append($('<li class="input">').append(l)).on("mouseup",function(){t=window.getSelection().toString()}).on("click",function(){t.length||l.focus()}).sortable({appendTo:document.body,items:"> .recipient",connectWith:".recipient-input",receive:function(e,t){var a=s.text();s.find(".recipient").remove(),o(a),t.sender&&t.sender.find("input").change()}}),$(e).css({position:"absolute",opacity:0,left:"-5000px",width:"10px"}).attr("tabindex",-1).after(s).on("focus",function(e){l.focus(),e.preventDefault()}).on("change",function(){$("li.recipient",s).remove(),l.val(this.value).change()}).change(),rcmail.init_address_input_events(l)}),$(".image-upload").each(function(){function e(){var e=-1!=(i.currentSrc||i.src).indexOf(rcmail.env.photo_placeholder);$(t)[e?"removeClass":"addClass"]("changed")}var t,a,i;t=this,a=$("<a>").attr({class:"icon button delete",href:"#"}).click(function(e){return rcmail.command("delete-photo","",this,e),!1}),i=$(t).find("img")[0],$(t).append(a).click(function(){rcmail.upload_input("upload-form")}),e(),$(i).on("load",e)}),$("textarea[data-html-editor]").each(function(){var e,t,a,i,n,o,s;e=this,a=!1,i=$(e),n=i.parent(),o=$('<a class="mce-i-html" href="#" tabindex="-1"></a>').attr("title",rcmail.gettext("htmltoggle")).on("click",function(e){rcmail.command("toggle-editor",{id:i.attr("id"),html:!0},"",e.originalEvent)&&n.addClass("ishtml")}).on("keydown",function(e){if(9==e.which)return i.focus(),!1}),s=$('<div class="editor-toolbar">').append(o),n.is("td")?(t=$('input[type="checkbox"]',n.parent().next()),a=!0):t=i.next("select.hidden"),function(n){var o,s,r=function(){if(!n.scrollHeight)return setTimeout(r,250);var e,t,a,i;o||(o=parseInt($(n).css("padding-top"))+parseInt($(n).css("padding-bottom"))+2,s=$(n).height()),n.scrollHeight-o<=s||(t=0,$(n).parents().each(function(){if(0<this.scrollTop)return t=(e=this).scrollTop,!1}),a=$(n).outerHeight(),$(n).outerHeight(0),i=Math.max(s,n.scrollHeight),$(n).outerHeight(a),i!==a&&$(n).height(i),t&&(e.scrollTop=t))};$(n).on("input",r).trigger("input")}(e),1==t.length&&(n.addClass("html-editor"),i.after(s).data("control",t).on("keydown",function(e){e.altKey&&121==e.which&&o.focus()}),a&&(t.parents("tr").first().hide(),n.prev().hide(),n.addClass("col-sm-12")))}),$("#dragmessage-menu,#dragcontact-menu").each(function(){rcmail.gui_object("dragmenu",this.id)}),$("#taskmenu > a").each(function(){var e,t,a;/button-([a-z]+)/.test(this.className)&&(t=RegExp.$1,(a=D(this.id))&&(e=a.data)&&(e.sel&&(e.sel=e.sel.replace("button-selected","selected")+" "+t),e.act&&(e.act+=" "+t),rcmail.buttons[a.command][a.index]=e,rcmail.init_button(a.command,e)),$(this).addClass(t),$(".button-inner",this).addClass("inner")),$(this).on("mouseover",function(){rcube_webmail.long_subject_title(this,0,$("span.inner",this))})}),$(".listbutton").each(function(){var e=D(this.id);$(this).addClass("button").removeClass("listbutton"),e.data.sel&&(e.data.sel=e.data.sel.replace("listbutton","button")),e.data.act&&(e.data.act=e.data.act.replace("listbutton","button")),rcmail.buttons[e.command][e.index]=e.data,rcmail.init_button(e.command,e.data)}),$("[data-hidden]").each(function(){for(var e,t=$(this).data("hidden"),a=$(this).parent("li"),i=/(large|big|small|phone|lbs)/g;e=i.exec(t);)$(a.length?a:this).addClass("hidden-"+e[1])}),$("[data-list]").each(function(){$("input[type=checkbox]",this).each(function(){pe(this)})}),k&&$(".formcontent").each(function(){$(this).next(".formbuttons").length&&$(this).parent().addClass("formcontainer")}),$("#attachment-list + a.zipdownload").appendTo(".header-links"),(_=$("html").is(".ipad,.iphone"))&&$(".iframe-wrapper, .scroller").addClass("ios-scroll"),$("html").filter(".ipad,.iphone,.webkit.mobile,.webkit.tablet").addClass("webkit-scroller").length&&$(E.menu).addClass("webkit-scroller"),$(".treelist").each(function(){function e(){$(t)[0<$(".treetoggle",t).length?"removeClass":"addClass"]("notree")}var t=this;window.MutationObserver&&new MutationObserver(e).observe(t,{childList:!0,subtree:!0}),e(),$("li.mailbox > a").on("mouseover",function(){rcube_webmail.long_subject_title_ex(this)})}),U()}var rcmail,rcube_webmail,bw;window.rcmail?(rcmail.show_menu=function(e,t,a){var i="object"==typeof e?e.menu:e,n=$("#"+i);return"string"==typeof e&&(e={menu:i}),rcmail.triggerEvent(!1===t?"menu-close":"menu-open",{name:i,obj:n,props:e,originalEvent:a})},rcmail.hide_menu=function(e,t){return rcmail.triggerEvent("menu-close",{name:e,props:{menu:e},originalEvent:t})}):(rcmail=parent.rcmail,rcube_webmail=parent.rcube_webmail,bw={});var __newInst,UI=new rcube_elastic_ui;$&&$.datepicker&&(__newInst=$.datepicker._newInst,$.extend($.datepicker,{_newInst:function(e,t){t=__newInst.call(this,e,t);return t.inline||UI.datepicker_init(t.dpDiv),t}}));
